<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleAudit Result Visualizer</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'severity-pass': '#22c55e',
                        'severity-low': '#3b82f6',
                        'severity-medium': '#eab308',
                        'severity-high': '#f97316',
                        'severity-critical': '#ef4444',
                        'severity-error': '#6b7280',
                    }
                }
            }
        }
    </script>
    <style>
        .folder-icon::before {
            content: "üìÅ";
            margin-right: 0.25rem;
        }
        .folder-icon.open::before {
            content: "üìÇ";
        }
        .file-icon::before {
            content: "üìÑ";
            margin-right: 0.25rem;
        }
        .tree-item {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }
        .tree-item.bg-indigo-100 {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .tree-children {
            margin-left: 1rem;
            border-left: 1px solid #e5e7eb;
            padding-left: 0.5rem;
        }
        
        /* Resizer styles */
        .resizer {
            width: 5px;
            cursor: col-resize;
            background: #e5e7eb;
            position: relative;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        .resizer:hover {
            background: #6366f1;
        }
        .resizer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -2px;
            right: -2px;
            bottom: 0;
        }
        .resizer::after {
            content: '‚ãÆ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #9ca3af;
            font-size: 20px;
            line-height: 1;
            pointer-events: none;
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            #file-tree-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                width: 75% !important;
                max-width: 320px;
            }
            #file-tree-sidebar.mobile-open {
                transform: translateX(0);
            }
            .mobile-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 40;
            }
            .mobile-overlay.active {
                display: block;
            }
            .resizer {
                display: none;
            }
            /* Mobile view: Stack scenario list on top of detail */
            #detail-view.has-selection {
                position: fixed;
                inset: 0;
                top: 73px; /* Below header */
                z-index: 30;
            }
            #scenario-list-container.has-detail {
                display: none;
            }
            .back-button {
                display: inline-flex !important;
            }
        }
        
        @media (min-width: 769px) {
            .back-button {
                display: none !important;
            }
        }
        
        .sidebar-hidden {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

    <main class="flex-1 flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="text-gray-600 hover:text-indigo-600 transition-colors" title="Toggle file tree">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <div>
                <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="hidden sm:inline">SimpleAudit Visualizer</span>
                    <span class="sm:hidden">SimpleAudit</span>
                </h1>
                <p class="text-sm text-gray-500 mt-1 hidden sm:block" id="file-info">No file loaded</p>
            </div>
        </div>
        <div>
            <input type="file" id="upload-json-input" accept=".json" class="hidden" onchange="handleUploadedFile(event)">
            <button onclick="document.getElementById('upload-json-input').click()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <span class="hidden md:inline">Upload JSON</span>
            </button>
        </div>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeMobileSidebar()"></div>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">

        <!-- File Tree Sidebar -->
        <div id="file-tree-sidebar" class="w-80 border-r border-gray-200 bg-white flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                <h2 class="font-semibold text-gray-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                    JSON Files
                </h2>
                <button onclick="loadFileTree()" class="text-gray-500 hover:text-indigo-600 transition-colors p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
            <div id="file-tree" class="flex-1 overflow-y-auto p-4">
                <div class="text-center text-gray-400 mt-10">
                    <div class="animate-spin h-8 w-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                    Loading files...
                </div>
            </div>
        </div>

        <!-- Resizer -->
        <div class="resizer" id="resizer"></div>

        <!-- Results View -->
        <div class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Sidebar / List View -->
            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                
                <div class="w-full md:w-1/3 border-r border-gray-200 bg-white flex flex-col" id="scenario-list-container">

                    <!-- Dashboard / Stats -->
                    <div id="dashboard" class="p-6 border-b border-gray-200 bg-gray-50 hidden">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 text-center">
                                <div class="text-xs text-gray-500 uppercase font-semibold">Pass Rate</div>
                                <div class="text-2xl font-bold text-gray-900" id="stat-pass-rate">-</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 text-center">
                                <div class="text-xs text-gray-500 uppercase font-semibold">Avg Score</div>
                                <div class="text-2xl font-bold text-gray-900" id="stat-avg-score">-</div>
                            </div>
                        </div>

                        <!-- Severity Bar -->
                        <div class="mt-2">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>Severity Breakdown</span>
                                <span id="stat-total-cases">0 cases</span>
                            </div>
                            <div class="h-3 rounded-full overflow-hidden flex w-full bg-gray-200" id="severity-bar">
                                <!-- Bars injected by JS -->
                            </div>
                            <div class="flex flex-wrap gap-2 mt-2 justify-center" id="severity-legend">
                                <!-- Legend injected by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="p-4 border-b border-gray-200 flex flex-col sm:flex-row gap-2 hidden" id="filters">
                        <input type="text" id="search-input" placeholder="Search scenarios..."
                            class="flex-1 bg-gray-100 border-none rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                        <select id="sort-select"
                            class="bg-gray-100 border-none rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 text-gray-700">
                            <option value="default">Default</option>
                            <option value="score-asc">Score (Low-High)</option>
                            <option value="score-desc">Score (High-Low)</option>
                            <option value="severity">Severity</option>
                        </select>
                    </div>

                    <!-- List -->
                    <div id="scenario-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <div class="text-center text-gray-400 mt-10">
                            Select a JSON file to view results.
                        </div>
                    </div>
                </div>

                <!-- Detail View -->
                <main class="flex-1 bg-gray-50 overflow-y-auto p-4 md:p-8" id="detail-view">
                    <div class="h-full flex flex-col items-center justify-center text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 opacity-50" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-lg">Select a scenario to view details</p>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // State
        let allScenarios = [];
        let currentScenarios = [];
        let selectedScenarioId = null;
        let currentFilePath = null;
        let sidebarWidth = 320; // Default width in pixels
        let expandedFolders = new Set(); // Track expanded folders

        // On page load, check for file and scenario in URL
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            let file = params.get('case');
            if (file) {
                try {
                    // decodeURIComponent twice to handle double encoding
                    file = decodeURIComponent(decodeURIComponent(file));
                } catch (e) {
                    file = decodeURIComponent(file);
                }
                const scenarioId = window.location.hash ? decodeURIComponent(window.location.hash.substring(1)) : null;
                if (file) {
                    // Load the file, then select the scenario if present
                    loadJsonFile(file, file).then(() => {
                        if (scenarioId) {
                            // Wait for scenarios to be loaded, then select
                            setTimeout(() => {
                                const found = allScenarios.find(s => s.id === scenarioId);
                                if (found) selectScenario(found);
                            }, 300);
                        }
                    });
                }
            }
        });

        // Constants
        const SEVERITY_COLORS = {
            'pass': 'bg-severity-pass',
            'low': 'bg-severity-low',
            'medium': 'bg-severity-medium',
            'high': 'bg-severity-high',
            'critical': 'bg-severity-critical',
            'ERROR': 'bg-severity-error',
        };

        const SEVERITY_TEXT_COLORS = {
            'pass': 'text-severity-pass',
            'low': 'text-severity-low',
            'medium': 'text-severity-medium',
            'high': 'text-severity-high',
            'critical': 'text-severity-critical',
            'ERROR': 'text-severity-error',
        };

        const SEVERITY_ORDER = {
            'critical': 0,
            'high': 1,
            'medium': 2,
            'low': 3,
            'pass': 4,
            'ERROR': -1,
        };

        const SEVERITY_SCORES_MAP = {
            'critical': 0,
            'high': 2.5,
            'medium': 5,
            'low': 7.5,
            'pass': 10,
            'ERROR': 0,
        };

        // Initialize
        document.getElementById('search-input').addEventListener('input', handleFilter);
        document.getElementById('sort-select').addEventListener('change', handleFilter);

        // Load file tree on page load
        loadFileTree();

        // Initialize resizer
        initResizer();

        // --- Sidebar Toggle Functions ---

        function toggleSidebar() {
            const sidebar = document.getElementById('file-tree-sidebar');
            const resizer = document.getElementById('resizer');
            const overlay = document.querySelector('.mobile-overlay');
            
            if (window.innerWidth < 768) {
                // Mobile behavior - toggle overlay sidebar
                const isOpen = sidebar.classList.contains('mobile-open');
                
                if (isOpen) {
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                } else {
                    sidebar.classList.add('mobile-open');
                    overlay.classList.add('active');
                }
            } else {
                // Desktop behavior - toggle hide/show
                sidebar.classList.toggle('sidebar-hidden');
                resizer.classList.toggle('sidebar-hidden');
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('file-tree-sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        // --- Resizer Functions ---

        function initResizer() {
            const resizer = document.getElementById('resizer');
            const sidebar = document.getElementById('file-tree-sidebar');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = sidebar.offsetWidth;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const dx = e.clientX - startX;
                const newWidth = Math.max(200, Math.min(600, startWidth + dx));
                
                sidebar.style.width = newWidth + 'px';
                sidebarWidth = newWidth;
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // --- File Tree Functions ---

        async function loadFileTree() {
            const container = document.getElementById('file-tree');
            container.innerHTML = '<div class="text-center text-gray-400"><div class="animate-spin h-8 w-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-2"></div>Loading files...</div>';
            
            try {
                const response = await fetch('/api/files');
                if (!response.ok) throw new Error('Failed to load files');
                
                const data = await response.json();
                renderFileTree(data.tree, container);
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-500 p-4">Error loading files: ${error.message}</div>`;
            }
        }

        function renderFileTree(items, container, level = 0) {
            if (items.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 p-4">No JSON files found.</div>';
                return;
            }

            const ul = document.createElement('div');
            ul.className = 'space-y-1';

            items.forEach(item => {
                const li = document.createElement('div');
                
                if (item.type === 'folder') {
                    // Folder with children
                    const folderDiv = document.createElement('div');
                    
                    const header = document.createElement('div');
                    header.className = 'tree-item flex items-center py-1 px-2 rounded hover:bg-gray-100 text-sm';
                    
                    // Check if this folder should be expanded (either explicitly or it contains the selected file)
                    const shouldBeOpen = expandedFolders.has(item.path) || isParentOfSelectedFile(item);
                    
                    header.innerHTML = `
                        <span class="folder-icon text-base ${shouldBeOpen ? 'open' : ''}"></span>
                        <span class="flex-1 font-medium text-gray-700">${escapeHtml(item.name)}</span>
                        <span class="text-xs text-gray-400">${item.children.length}</span>
                    `;
                    
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = `tree-children ${shouldBeOpen ? '' : 'hidden'}`;
                    
                    header.onclick = (e) => {
                        e.stopPropagation();
                        const icon = header.querySelector('.folder-icon');
                        const isOpen = icon.classList.toggle('open');
                        childrenDiv.classList.toggle('hidden');
                        
                        // Track expanded state
                        if (isOpen) {
                            expandedFolders.add(item.path);
                        } else {
                            expandedFolders.delete(item.path);
                        }
                    };
                    
                    folderDiv.appendChild(header);
                    folderDiv.appendChild(childrenDiv);
                    
                    renderFileTree(item.children, childrenDiv, level + 1);
                    li.appendChild(folderDiv);
                    
                } else if (item.type === 'file') {
                    // JSON file
                    const fileDiv = document.createElement('div');
                    const isSelected = currentFilePath === item.path;
                    fileDiv.className = `tree-item flex items-center py-1 px-2 rounded hover:bg-indigo-50 text-sm transition-colors ${isSelected ? 'bg-indigo-100 ring-1 ring-indigo-500' : ''}`;
                    fileDiv.innerHTML = `
                        <span class="file-icon text-base"></span>
                        <span class="flex-1 text-gray-700 ${isSelected ? 'font-semibold' : ''}">${escapeHtml(item.name)}</span>
                    `;
                    fileDiv.onclick = () => loadJsonFile(item.path, item.name);
                    li.appendChild(fileDiv);
                }
                
                ul.appendChild(li);
            });

            container.innerHTML = '';
            container.appendChild(ul);
        }
        
        // Helper function to check if a folder contains the selected file
        function isParentOfSelectedFile(folder) {
            if (!currentFilePath) return false;
            return currentFilePath.startsWith(folder.path + '/') || currentFilePath.startsWith(folder.path + '\\');
        }

        // Handle uploaded file
        function handleUploadedFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Clear file tree selection since this is a custom upload
                    currentFilePath = null;
                    
                    // Update file tree to clear any selection
                    loadFileTree();
                    
                    // Close mobile sidebar
                    if (window.innerWidth < 768) {
                        closeMobileSidebar();
                    }
                    
                    // Process the uploaded data
                    processData(data, file.name + ' (uploaded)');
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file');
            };
            
            reader.readAsText(file);
            
            // Reset input so the same file can be uploaded again
            event.target.value = '';
        }

        async function loadJsonFile(path, filename) {
            currentFilePath = path;
            
            // Close mobile sidebar when file is selected
            if (window.innerWidth < 768) {
                closeMobileSidebar();
            }
            
            // Update file tree to show selection and expand parent folders
            await loadFileTree();
            
            // Scroll selected file into view
            setTimeout(() => {
                const selectedFile = document.querySelector('.tree-item.bg-indigo-100');
                if (selectedFile) {
                    selectedFile.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
            
            // Show loading state
            document.getElementById('file-info').textContent = `Loading ${filename}...`;
            document.getElementById('scenario-list').innerHTML = '<div class="text-center text-gray-400 mt-10"><div class="animate-spin h-8 w-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-2"></div>Loading...</div>';
            
            try {
                const response = await fetch(`/api/json/${encodeURIComponent(path)}`);
                if (!response.ok) throw new Error('Failed to load JSON file');
                
                const data = await response.json();
                processData(data, filename);
            } catch (error) {
                document.getElementById('file-info').textContent = `Error: ${error.message}`;
                document.getElementById('scenario-list').innerHTML = `<div class="text-center text-red-500 p-4">Error loading file: ${error.message}</div>`;
            }
        }

        // --- Data Processing ---

        function processData(data, filename) {
            // Handle different potential JSON structures
            if (Array.isArray(data)) {
                allScenarios = data;
            } else if (data.results && Array.isArray(data.results)) {
                allScenarios = data.results;
            } else {
                document.getElementById('file-info').textContent = `Error: Invalid format`;
                document.getElementById('scenario-list').innerHTML = `
                    <div class="text-center text-red-500 p-4 m-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="font-semibold mb-2">Invalid JSON Format</p>
                        <p class="text-sm text-gray-600">Expected a list of results or an object with a "results" array.</p>
                    </div>
                `;
                return;
            }

            // Global score from summary if available
            let globalScore = null;
            if (data.summary && data.summary.score !== undefined) {
                globalScore = data.summary.score;
            }

            // Assign IDs and normalized fields if missing
            allScenarios.forEach((s, i) => {
                if (!s.id) s.id = `scenario-${i}`;

                // History normalization
                if (!s.history && s.conversation) {
                    s.history = s.conversation;
                }

                // Severity normalization
                if (!s.severity) {
                    if (s.score === 10) s.severity = 'pass';
                    else if (s.issues_found && s.issues_found.length > 0) s.severity = 'medium';
                    else s.severity = 'medium';
                }

                // Score normalization
                if (s.score === undefined && s.severity) {
                    s.score = SEVERITY_SCORES_MAP[s.severity.toLowerCase()] || 0;
                }

                // Judge Feedback normalization
                if (!s.reasoning) {
                    let parts = [];
                    if (s.summary) parts.push(`### Summary\n${s.summary}`);
                    if (s.issues_found && s.issues_found.length > 0) {
                        parts.push(`### Issues Found\n- ${s.issues_found.join('\n- ')}`);
                    }
                    if (s.positive_behaviors && s.positive_behaviors.length > 0) {
                        parts.push(`### Positive Behaviors\n- ${s.positive_behaviors.join('\n- ')}`);
                    }
                    if (s.recommendations && s.recommendations.length > 0) {
                        parts.push(`### Recommendations\n- ${s.recommendations.join('\n- ')}`);
                    }
                    s.reasoning = parts.join('\n\n');
                }
            });

            document.getElementById('file-info').textContent = `${filename} ‚Ä¢ ${allScenarios.length} scenarios`;
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('filters').classList.remove('hidden');

            updateStats(globalScore);
            handleFilter();
        }

        // --- Stats & Dashboard ---

        function updateStats(globalScore) {
            const total = allScenarios.length;
            const passed = allScenarios.filter(s => s.severity === 'pass' || s.score === 10).length;
            const passRate = total === 0 ? 0 : Math.round((passed / total) * 100);

            let avgScore = 'N/A';
            if (globalScore !== null && globalScore !== undefined) {
                avgScore = globalScore;
            } else {
                const scores = allScenarios.map(s => s.score).filter(s => s !== undefined);
                const totalScore = scores.reduce((sum, s) => sum + s, 0);
                avgScore = scores.length === 0 ? 'N/A' : (totalScore / scores.length).toFixed(1);
            }

            document.getElementById('stat-pass-rate').textContent = `${passRate}%`;
            document.getElementById('stat-avg-score').textContent = avgScore;
            document.getElementById('stat-total-cases').textContent = `${total} cases`;

            // Severity Bar
            const counts = {
                'critical': 0, 'high': 0, 'medium': 0, 'low': 0, 'pass': 0
            };
            allScenarios.forEach(s => {
                const sev = (s.severity || 'low').toLowerCase();
                if (counts[sev] !== undefined) counts[sev]++;
            });

            const barContainer = document.getElementById('severity-bar');
            barContainer.innerHTML = '';

            const legendContainer = document.getElementById('severity-legend');
            legendContainer.innerHTML = '';

            Object.keys(counts).forEach(sev => {
                const count = counts[sev];
                if (count > 0) {
                    const pct = (count / total) * 100;

                    const segment = document.createElement('div');
                    segment.className = `${SEVERITY_COLORS[sev]} h-full transition-all duration-500`;
                    segment.style.width = `${pct}%`;
                    segment.title = `${sev}: ${count}`;
                    barContainer.appendChild(segment);

                    const item = document.createElement('div');
                    item.className = "flex items-center gap-1 text-xs bg-white px-2 py-1 rounded border border-gray-100 shadow-sm";
                    item.innerHTML = `<span class="w-2 h-2 rounded-full ${SEVERITY_COLORS[sev]}"></span> <span class="capitalize">${sev}</span> <span class="font-bold text-gray-700">${count}</span>`;
                    legendContainer.appendChild(item);
                }
            });
        }

        // --- Filtering and List Rendering ---

        function handleFilter() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const sortMode = document.getElementById('sort-select').value;

            currentScenarios = allScenarios.filter(s => {
                const name = (s.scenario_name || s.name || '').toLowerCase();
                const desc = (s.scenario_description || s.description || '').toLowerCase();
                return name.includes(query) || desc.includes(query);
            });

            currentScenarios.sort((a, b) => {
                if (sortMode === 'score-asc') return (a.score || 0) - (b.score || 0);
                if (sortMode === 'score-desc') return (b.score || 0) - (a.score || 0);
                if (sortMode === 'severity') {
                    return SEVERITY_ORDER[a.severity || 'low'] - SEVERITY_ORDER[b.severity || 'low'];
                }
                return 0;
            });

            renderList();
        }

        function renderList() {
            const container = document.getElementById('scenario-list');
            container.innerHTML = '';

            if (currentScenarios.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 mt-10">No matching scenarios found.</div>';
                return;
            }

            currentScenarios.forEach(s => {
                const el = document.createElement('div');
                const isSelected = selectedScenarioId === s.id;
                const statusColor = SEVERITY_COLORS[s.severity || 'low'];
                const textColor = SEVERITY_TEXT_COLORS[s.severity || 'low'];

                el.className = `p-3 rounded-lg border cursor-pointer hover:bg-gray-50 transition-colors flex gap-3 ${isSelected ? 'border-indigo-500 ring-1 ring-indigo-500 bg-indigo-50' : 'border-gray-200 bg-white'}`;
                el.onclick = () => selectScenario(s);

                el.innerHTML = `
                    <div class="w-1.5 self-stretch rounded-full ${statusColor} shrink-0"></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="font-medium text-gray-900 truncate text-sm" title="${s.scenario_name || s.name}">${s.scenario_name || s.name || 'Untitled Scenario'}</h3>
                            <span class="text-xs font-bold ${textColor} ml-2 shrink-0">${s.score !== undefined ? s.score + '/10' : ''}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 line-clamp-2">${s.scenario_description || s.description || 'No description'}</p>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- Detail Rendering ---

        function selectScenario(scenario) {
            selectedScenarioId = scenario.id;
            renderList();
            renderDetail(scenario);
            // Update URL with ?case=...#scenario-id
            if (history.pushState) {
                const url = new URL(window.location);
                if (currentFilePath) {
                    url.searchParams.set('case', encodeURIComponent(currentFilePath));
                }
                url.hash = `#${encodeURIComponent(scenario.id)}`;
                window.history.pushState({scenarioId: scenario.id, case: currentFilePath}, '', url);
            } else {
                let hash = `#${encodeURIComponent(scenario.id)}`;
                if (currentFilePath) {
                    window.location.search = `?case=${encodeURIComponent(currentFilePath)}`;
                }
                window.location.hash = hash;
            }
            // Mobile: Show detail view full screen
            if (window.innerWidth < 768) {
                document.getElementById('detail-view').classList.add('has-selection');
                document.getElementById('scenario-list-container').classList.add('has-detail');
            }
        }

        function closeDetailView() {
            // Mobile: Go back to list view
            document.getElementById('detail-view').classList.remove('has-selection');
            document.getElementById('scenario-list-container').classList.remove('has-detail');
            selectedScenarioId = null;
            
            // Reset detail view
            const container = document.getElementById('detail-view');
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 opacity-50" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="text-lg">Select a scenario to view details</p>
                </div>
            `;
        }

        function renderDetail(s) {
            const container = document.getElementById('detail-view');
            const statusColor = SEVERITY_COLORS[s.severity || 'low'];
            const textColor = SEVERITY_TEXT_COLORS[s.severity || 'low'];

            const name = s.scenario_name || s.name || 'Untitled';
            const desc = s.scenario_description || s.description || '';
            const score = s.score;
            const severity = s.severity || 'unknown';
            const history = s.history || [];
            const judgeFeedback = s.reasoning || s.feedback || 'No feedback available.';

            let html = `
                <div class="max-w-4xl mx-auto space-y-6 pb-20">
                    <!-- Mobile Back Button -->
                    <button onclick="closeDetailView()" class="back-button mb-4 flex items-center gap-2 text-indigo-600 hover:text-indigo-700 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Back to list
                    </button>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900 leading-tight">${name}</h2>
                                <div class="flex items-center gap-3 mt-2">
                                    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium uppercase tracking-wide ${statusColor} text-white bg-opacity-90">
                                        ${severity}
                                    </span>
                                    <span class="text-sm text-gray-500">Score: <strong class="${textColor}">${score !== undefined ? score + '/10' : 'N/A'}</strong></span>
                                </div>
                            </div>
                        </div>
                        <p class="text-gray-600 leading-relaxed">${desc}</p>
                    </div>
            `;

            if (history && history.length > 0) {
                html += `<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center justify-between">
                                <h3 class="font-semibold text-gray-700">Conversation History</h3>
                                <button onclick="copyCurrentUrl()" title="Copy link to this scenario" class="ml-2 px-2 py-1 text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded transition-colors border border-indigo-200 flex items-center gap-1">
                                    <svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 16h8a2 2 0 002-2V8a2 2 0 00-2-2H8a2 2 0 00-2 2v6a2 2 0 002 2zm0 0v2a2 2 0 002 2h4a2 2 0 002-2v-2' /></svg>
                                    Copy URL
                                </button>
                            </div>
                            <div class="divide-y divide-gray-100">`;

                history.forEach((turn, idx) => {
                    const role = (turn.role || 'unknown').toUpperCase();
                    const content = turn.content || '';
                    const isUser = role === 'USER' || role === 'HUMAN';

                    html += `
                        <div class="p-6 ${isUser ? 'bg-white' : 'bg-gray-50'}">
                            <div class="flex gap-4">
                                <div class="shrink-0 mt-1">
                                    <span class="inline-flex items-center justify-center h-8 w-8 rounded-full ${isUser ? 'bg-indigo-100 text-indigo-600' : 'bg-green-100 text-green-600'} font-bold text-xs ring-4 ring-white">
                                        ${isUser ? 'U' : 'AI'}
                                    </span>
                                </div>
                                <div class="flex-1 space-y-1">
                                    <div class="flex items-center justify-between">
                                        <h4 class="text-sm font-semibold text-gray-900">${role}</h4>
                                        <span class="text-xs text-gray-400">Turn ${idx + 1}</span>
                                    </div>
                                    <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap font-mono text-xs bg-gray-50/50 p-2 rounded border border-gray-100">${escapeHtml(content)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `   </div>
                        </div>`;
            } else {
                html += `<div class="p-6 text-center text-gray-400 italic">No conversation history data found.</div>`;
            }

            html += `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-indigo-50 px-6 py-3 border-b border-indigo-100 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            <h3 class="font-semibold text-indigo-900">Judge Feedback</h3>
                        </div>
                        <div class="p-6 prose prose-indigo max-w-none text-gray-800">
                            <pre class="whitespace-pre-wrap font-sans text-sm text-gray-700">${escapeHtml(judgeFeedback)}</pre>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function escapeHtml(unsafe) {
            return (unsafe || "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Copy current URL to clipboard
        function copyCurrentUrl() {
            const url = window.location.href;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showCopyToast();
                });
            } else {
                // fallback
                const tempInput = document.createElement('input');
                tempInput.value = url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showCopyToast();
            }
        }

        // Show a toast message after copying
        function showCopyToast() {
            let toast = document.getElementById('copy-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'copy-toast';
                toast.className = 'fixed bottom-6 right-6 bg-indigo-600 text-white px-4 py-2 rounded shadow-lg z-50 text-sm';
                toast.textContent = 'Link copied!';
                document.body.appendChild(toast);
            }
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 1800);
        }

    </script>

    </main>
    <footer class="w-full text-center py-4 bg-gray-50 border-t border-gray-200">
        <a href="https://pypi.org/project/simpleaudit/" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">simpleaudit on PyPI</a>
    </footer>
</body>

</html>
